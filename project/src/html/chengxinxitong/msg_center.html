<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link rel="stylesheet" href="../../css/style-chengxintong.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="http://cdn.bootcss.com/vue/2.1.10/vue.min.js"></script>
    <title>消息中心</title>
  </head>
  <body>
    <div class="msg-center-container" id="app">
      <header>
        <a href="javascript:history.back();"><img class="back-btn" src="../../img/图标/返回.png" alt=""></a>
        消息中心
        <span class="right-btn" @click="deleteMsgs">清空</span>
      </header>
      <section class="main-content">
        <div class="msg-cell-content">
          <div class="msg-cell" v-for="item in msgList" :data-id="item.id" @click="setMsgRead(item.id, $event)">
            <img v-show="item.type == 1" class="msg-cell-avatar" src="../../img/图标/消息icon.png" alt="">
            <img v-show="item.type == 0" class="msg-cell-avatar" src="../../img/图标/消息icon-active.png" alt="">
            <div class="text-content">
              <p class="title">{{ item.title }}</p>
              <p class="subtitle">{{ item.content }}</p>
            </div>
            <p class="time">{{ item.time }}</p>
          </div>
        </div>
      </section>
    </div>
  </body>
  <script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="../../js/chengxinxitong/utils.js"></script>
  <script type="text/javascript" src="../../js/chengxinxitong/jquery.cookie.js"></script>
  <script type="text/javascript">
    var _identify = get_identify_safe()
    axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
    var vm = new Vue({
      el: '#app',
      data: function() {
        return {
          msgList: '',
          msgId: []
        }
      },
      mounted: function() {
        this.getMsgList()
      },
      methods: {
        getMsgList: function() {
          var _this = this
          var params = new URLSearchParams();
          params.append('identify', _identify)
          axios.post('http://s.chengxinxitong.com/app1.0.0/getUserMessageListData.action', params)
            .then(function (response) {
              _this.msgList = response.data.list

            })
            .catch(function (error) {
              console.log(error);
            });
        },
        setMsgRead: function(msg_id, $event) {
          var _this = this
          var params = new URLSearchParams();
          params.append('identify', _identify)
          params.append('id', msg_id)
          axios.post('http://s.chengxinxitong.com/app1.0.0/setUserMessageRead.action', params)
            .then(function (response) {
              if (response.data.errno == '0') {
                $("div[data-id='" + msg_id + "'] img").attr('src', '../../img/图标/消息icon.png')
              }
            })
            .catch(function (error) {
              console.log(error);
            });
        },
        deleteMsgs() {
          var _this = this
          var params = new URLSearchParams();
          this.msgId = this.msgList.map(function(item) {
            return item.id
          })
          params.append('identify', _identify)
          params.append('id', this.msgId.join(','))
          axios.post('http://s.chengxinxitong.com/app1.0.0/delUserMessage.action', params)
            .then(function (response) {
              if (response.data.errno == '0') {
                _this.msgList = ''
                alert('操作成功！')
              } else {
                alert(response.data.error)
              }
            })
            .catch(function (error) {
              console.log(error);
            });
          console.log(this.msgId.join(','))
        }
      }
    })
  </script>
</html>
